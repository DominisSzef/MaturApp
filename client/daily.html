<!DOCTYPE html>
<html lang="pl" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>MaturApp - Daily</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-black">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary sticky-top py-3">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold text-primary fs-3 ps-3" href="dashboard.html">
      <i class="bi bi-rocket-takeoff"></i> MaturApp
    </a>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto ms-4 gap-2">
        <li class="nav-item">
          <a class="nav-link text-secondary hover-light" href="dashboard.html"><i class="bi bi-book-half"></i> Wiedza</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active fw-bold text-success" href="daily.html"><i class="bi bi-calendar-check-fill"></i> Daily</a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-warning" href="calculator.html" target="_blank"><i class="bi bi-calculator-fill"></i> Kalkulator</a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-info" href="formulas.html" target="_blank"><i class="bi bi-file-earmark-pdf-fill"></i> Wzory</a>
        </li>
      </ul>

      <div class="d-flex align-items-center gap-3 pe-3">
        <a href="profile.html" class="d-flex align-items-center text-decoration-none group-hover">
          <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
            <i class="bi bi-person-fill text-white"></i>
          </div>
          <strong id="nav-username" class="text-white">User</strong>
        </a>
        <button onclick="logout()" class="btn btn-outline-secondary btn-sm ms-2"><i class="bi bi-box-arrow-right"></i></button>
      </div>
    </div>
  </div>
</nav>

<div class="container d-flex flex-column justify-content-center align-items-center fade-in mt-5" style="min-height: 70vh;">

  <div class="text-center mb-4">
    <h1 class="display-3 fw-bold text-white mb-2">Daily Streak üî•</h1>
    <p class="lead text-secondary">RozwiƒÖ≈º zadanie dnia i zgarnij <span class="text-warning fw-bold" id="header-points">+0 XP</span></p>
  </div>

  <div class="card bg-dark text-white daily-glow shadow-lg" style="width: 100%; max-width: 700px;">
    <div class="card-header bg-success text-white fw-bold p-3 d-flex justify-content-between align-items-center">
      <span><i class="bi bi-star-fill"></i> WYZWANIE DNIA</span>
      <span class="badge bg-white text-success" id="task-badge-points">≈Åadowanie...</span>
    </div>

    <div class="card-body p-5 text-center">

      <div id="loading" class="spinner-border text-success my-4" role="status">
        <span class="visually-hidden">≈Åadowanie...</span>
      </div>

      <div id="task-container" class="d-none">
        <h2 class="mb-4 text-warning" id="task-topic">Dzia≈Ç: ...</h2>
        <p class="fs-4 mb-5 text-light" style="line-height: 1.5;" id="task-question">
          Trwa pobieranie zadania...
        </p>

        <div class="form-floating mb-4 w-75 mx-auto">
          <input type="text" class="form-control bg-black text-white border-secondary" id="user-answer" placeholder="Wynik">
          <label for="user-answer" class="text-secondary">Wpisz sw√≥j wynik (np. 4, 1/3, -5)</label>
        </div>

        <button class="btn btn-success btn-lg px-5 py-3 fw-bold shadow w-75" id="check-btn" onclick="checkAnswer()">
          Zatwierd≈∫ odpowied≈∫
        </button>

        <div id="msg" class="mt-4 fw-bold fs-5" style="min-height: 30px;"></div>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/session.js"></script>
<script>
  if(typeof currentUser !== 'undefined') document.getElementById('nav-username').innerText = currentUser.username;
</script>

<script>
  let expectedAnswer = "";
  let rewardPoints = 0;
  // Bierzemy dzisiejszƒÖ datƒô (np. "2026-02-25")
  const todayDate = new Date().toISOString().split('T')[0];

  async function loadDailyTask() {
    // Sprawdzamy czy user jest zalogowany (korzystamy z Twojego session.js)
    if (typeof currentUser === 'undefined' || !currentUser) {
      showError("Musisz byƒá zalogowany, aby wykonaƒá Daily.");
      return;
    }

    // 1. BLOKADA: Sprawdzamy czy ju≈º dzisiaj to rozwiƒÖza≈Ç
    const lastCompleted = localStorage.getItem(`daily_completed_${currentUser.username}`);
    if (lastCompleted === todayDate) {
      showAlreadyCompleted();
      return; // Zatrzymujemy pobieranie, pokazujemy ekran uko≈Ñczenia
    }

    // 2. Pobieramy zadanie z backendu C#
    try {
      const response = await fetch('http://localhost:8080/api/daily/task-of-the-day');

      if (response.ok) {
        const task = await response.json();

        // Wrzucamy dane na ekran
        document.getElementById('task-topic').innerText = `Dzia≈Ç: ${task.topic}`;
        document.getElementById('task-question').innerText = task.question;
        document.getElementById('header-points').innerText = `+${task.rewardPoints} XP`;
        document.getElementById('task-badge-points').innerText = `Nagroda: ${task.rewardPoints} XP`;

        expectedAnswer = task.expectedAnswer;
        rewardPoints = task.rewardPoints;

        document.getElementById('loading').classList.add('d-none');
        document.getElementById('task-container').classList.remove('d-none');
      } else {
        showError("Nie uda≈Ço siƒô pobraƒá dzisiejszego zadania.");
      }
    } catch (error) {
      console.error(error);
      showError("B≈ÇƒÖd serwera. Upewnij siƒô, ≈ºe Docker z backendem jest odpalony.");
    }
  }

  function checkAnswer() {
    const inputField = document.getElementById('user-answer');
    const userAnswer = inputField.value.trim();
    const msgDiv = document.getElementById('msg');
    const checkBtn = document.getElementById('check-btn');

    if (!userAnswer) {
      msgDiv.className = "mt-4 fw-bold text-warning";
      msgDiv.innerHTML = "Wpisz wynik!";
      return;
    }

    const normalizedUser = userAnswer.toLowerCase().replace(',', '.');
    const normalizedExpected = expectedAnswer.toLowerCase().replace(',', '.');

    if (normalizedUser === normalizedExpected) {
      // SUKCES!
      msgDiv.className = "mt-4 fw-bold text-success fs-5";
      msgDiv.innerHTML = `<i class="bi bi-check-circle-fill"></i> Brawo! Zdobywasz +${rewardPoints} XP.`;

      inputField.disabled = true;
      checkBtn.disabled = true;
      checkBtn.classList.replace('btn-success', 'btn-secondary');
      checkBtn.innerText = "Zadanie uko≈Ñczone na dzi≈õ!";

      // 1. Zapisujemy flagƒô, ≈ºe dzisiaj zrobione
      localStorage.setItem(`daily_completed_${currentUser.username}`, todayDate);

      // 2. Dodajemy XP w lokalnej sesji przeglƒÖdarki (≈ºeby profil od razu to widzia≈Ç)
      currentUser.xp = (currentUser.xp || 0) + rewardPoints;

      // Zapisujemy pod wszystkimi standardowymi kluczami, ≈ºeby uniknƒÖƒá b≈Çƒôdu z session.js
      if(localStorage.getItem('currentUser')) localStorage.setItem('currentUser', JSON.stringify(currentUser));
      if(localStorage.getItem('user')) localStorage.setItem('user', JSON.stringify(currentUser));
      if(localStorage.getItem('userSession')) localStorage.setItem('userSession', JSON.stringify(currentUser));

      // 3. WYSY≈ÅAMY DO BACKENDU (≈ºeby po od≈õwie≈ºeniu/wylogowaniu XP nie zniknƒô≈Ço!)
      saveXpToDatabase(currentUser.username, rewardPoints);

    } else {
      // B≈ÅƒÑD
      msgDiv.className = "mt-4 fw-bold text-danger";
      msgDiv.innerHTML = `<i class="bi bi-x-circle-fill"></i> Z≈Ça odpowied≈∫. Spr√≥buj jeszcze raz!`;
    }
  }

  // Funkcja strzelajƒÖca do C# z nowymi punktami
  async function saveXpToDatabase(username, xpToAdd) {
    try {
      await fetch('http://localhost:8080/api/auth/add-xp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: username,
          xp: xpToAdd
        })
      });
      console.log("XP zapisane w bazie!");
    } catch (error) {
      console.error("B≈ÇƒÖd zapisu XP w bazie:", error);
    }
  }

  function showAlreadyCompleted() {
    document.getElementById('loading').classList.add('d-none');
    document.getElementById('task-container').classList.remove('d-none');
    document.getElementById('task-container').innerHTML = `
            <div class="py-4 text-center">
                <h1 class="text-success display-1 mb-3"><i class="bi bi-check-circle-fill"></i></h1>
                <h2 class="text-white fw-bold mb-3">Zadanie ju≈º wykonane!</h2>
                <p class="text-secondary fs-5 mb-0">Punkty dodane. Wr√≥ƒá jutro po nowƒÖ dawkƒô XP!</p>
            </div>
        `;
  }

  function showError(text) {
    document.getElementById('loading').classList.add('d-none');
    document.getElementById('task-container').classList.remove('d-none');
    document.getElementById('task-container').innerHTML = `<h4 class="text-danger mt-4 text-center">${text}</h4>`;
  }

  // Startujemy
  window.addEventListener('DOMContentLoaded', loadDailyTask);
</script>

</body>
</html>